---
- name: Bootstrap new Raspberry Pi (zero-w)
  hosts: pi_zero
  remote_user: pi
  become: yes

  tasks:
    - name: Enable en_US.UTF-8 Locale
      lineinfile:
        path: "/etc/locale.gen"
        regex: ^(# *)?en_US\.UTF-8
        line: en_US.UTF-8 UTF-8
        state: present
        backrefs: yes
      notify:
        - "locale configuration change"
        - Reboot
    - name: Set default locale en_US.UTF-8
      lineinfile:
        path: "/etc/default/locale"
        regex: ^\s*LANG=
        line: LANG=en_US.UTF-8
        state: present
        backrefs: yes
      notify: Reboot

    - name: Disable Password Authentication for SSH
      lineinfile:
        path: "/etc/ssh/sshd_config"
        regex: ^(# *)?PasswordAuthentication
        line: PasswordAuthentication no
        state: present
        backrefs: yes
      notify: "sshd configuration change"

    - name: Update /etc/hostname
      lineinfile:
        path: /etc/hostname
        regex: ^raspberrypi$
        line: "{{ inventory_hostname }}"
      notify: Reboot
    - name: Update /etc/hosts
      lineinfile:
        path: /etc/hosts
        regex: ^127\.0\.1\.1
        line: "127.0.1.1         {{ inventory_hostname }}"

    - name: Flush Handlers
      meta: flush_handlers

    - name: Remove non-systemd netowkring packages
      apt:
        state: absent
        pkg:
          - dhcpcd5
          - fake-hwclock
          - ifupdown
          - isc-dhcp-client
          - isc-dhcp-common
          - openresolv
        purge: yes
    - name: Create network configuration file
      copy:
        dest: /etc/systemd/network/10-wlan0.network
        src: 10-wlan0.network
    - name: Enable systemd-networkd
      service: 
        name: systemd-networkd
        enabled: yes
      notify: Reboot
    - name: Link resolv.conf
      file:
        src: /run/systemd/resolve/resolv.conf
        dest: /etc/resolv.conf
        state: link
        force: yes
    - name: Enable systemd-resolved
      service: 
        name: systemd-resolved
        enabled: yes
      notify: Reboot
    - name: Enable systemd-timesyncd
      service: 
        name: systemd-timesyncd
        enabled: yes
      notify: Reboot
    - name: Look for original wpa_supplicant.conf
      stat:
        path: /etc/wpa_supplicant/wpa_supplicant.conf
      register: wpa_supplicant
    - name: Hard link to wpa_supplicant.conf
      file:
        src: /etc/wpa_supplicant/wpa_supplicant.conf
        dest: /etc/wpa_supplicant/wpa_supplicant-wlan0.conf
        state: hard
      when: wpa_supplicant.stat.exists
    - name: Remove original wpa_supplicant.conf
      file:
        path: /etc/wpa_supplicant/wpa_supplicant.conf
        state: absent
      when: wpa_supplicant.stat.exists
    - name: Enable wpa_supplicant@wlan0
      service: 
        name: wpa_supplicant@wlan0
        enabled: yes
      notify: Reboot
  
  handlers:
    - name: Restart SSH Service
      ansible.builtin.service:
        name: sshd
        state: restarted
      listen: "sshd configuration change"
    - name: Generate Locales
      command: /usr/sbin/locale-gen
      listen: "locale configuration change"
    - name: Reboot
      reboot:

